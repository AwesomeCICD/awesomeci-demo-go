version: v1.0
name: awesomeci-demo-go
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
  containers:
    - name: main
      image: 'circleci/golang:1.12'
    - name: db
      image: 'circleci/postgres:9.6-alpine'
      env_vars:
        - name: POSTGRES_PASSOWRD
          value: keyboard-cat
blocks:
  - name: Build
    task:
      jobs:
        - name: Build Block
          commands:
            - checkout
            - sudo apt update
            - sudo apt install lftp -y
            - mkdir -p $TEST_RESULTS
            - cache restore go-mod-v4-$(checksum go.sum)
            - 'dockerize -wait tcp://db:5432 -timeout 1m'
            - make
            - 'gotestsum --junitfile ${TEST_RESULTS}/gotestsum-report.xml'
            - cache store go-mod-v4-$(checksum go.sum) /go/pkg/mod
      env_vars:
        - name: TEST_RESULTS
          value: /tmp/test-results
        - name: CONTACTS_DB_URL
          value: >-
            postgres://circleci-demo-go@db:5432/circle_test?sslmode=disable
        - name: ' CONTACTS_DB_MIGRATIONS'
          value: /home/circleci/project/db/migrations
